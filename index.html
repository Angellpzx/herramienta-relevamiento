<!DOCTYPE html>
<html lang="es">
<head>
    <title>Herramienta Relevamiento</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìç</text></svg>" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch@3.11.0/dist/geosearch.css"/>

    <style>
        :root {
            --primary-color: #6c9bcf; --primary-hover-color: #5a85b6;
            --success-color: #a3d9a5; --error-color: #f7b2b2; --info-color: #f9d29d;
            --text-color: #333; --shadow-color: rgba(0, 0, 0, 0.2); --light-bg: #ffffff;
        }
        
        html, body, #mapa {
            height: 100%; width: 100%; margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            overflow: hidden;
        }

        /* --- ESTILOS PARA EL BUSCADOR --- */
        /* Posiciona el control del buscador en la esquina superior izquierda */
        .leaflet-control-geosearch.leaflet-bar {
            top: 15px;
            left: 15px;
        }
        /* Contenedor principal del buscador */
        .leaflet-control-geosearch form {
            display: flex; /* Activa Flexbox para alinear los elementos internos */
            align-items: center; /* Centra verticalmente el icono y el input */
            border: none;
            border-radius: 50px !important;
            box-shadow: 0 2px 8px var(--shadow-color);
            height: 44px; /* Altura fija para un buen centrado */
            overflow: hidden; /* ¬°CLAVE! Evita que el input se desborde */
            background-color: var(--light-bg);
        }
        /* Estilos para el campo de texto */
        .leaflet-control-geosearch input {
            border: none;
            outline: none;
            background: transparent;
            padding: 0 15px;
            font-size: 16px;
            width: 100%;
            height: 100%; /* Ocupa toda la altura del contenedor */
            box-sizing: border-box; /* El padding no aumenta el tama√±o total */
        }
        
        /* --- 2. POSICI√ìN DEL BOT√ìN DE EXPORTAR --- */
        #export-container {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        .btn-round {
            background-color: var(--primary-color); color: white; border: none;
            border-radius: 50px; padding: 12px 25px; font-size: 16px; font-weight: 500;
            cursor: pointer; box-shadow: 0 2px 5px var(--shadow-color);
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .btn-round:hover { transform: translateY(-2px); }

        #message-box {
            position: absolute; bottom: 20px; left: 50%;
            transform: translateX(-50%); z-index: 1000;
            padding: 12px 20px; border-radius: 12px; min-width: 300px; text-align: center;
            font-weight: 500; opacity: 0; transition: all 0.5s ease;
            background-color: var(--info-color);
        }
        #message-box.visible { opacity: 1; transform: translate(-50%, -10px); }

        .popup-delete-button {
            background-color: var(--error-color); color: var(--text-color);
            border: 1px solid #d32f2f; padding: 8px 12px; border-radius: 5px;
            cursor: pointer; margin-top: 10px; display: block; width: 100%;
            text-align: center; font-weight: bold;
        }
        .popup-delete-button:hover { background-color: #e57373; }
    </style>
</head>
<body>

    <div id="mapa"></div>
    
    <div id="export-container">
        <button id="exportar-kmz-btn" class="btn-round">Exportar a KMZ</button>
    </div>
    
    <div id="message-box"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/leaflet-geosearch@3.11.0/dist/geosearch.umd.js"></script>
    
    <script>
    const maxZoomLevel = 19;
    const mapaCalles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        maxZoom: maxZoomLevel
    });
    const mapaSatelital = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { 
        attribution: 'Tiles &copy; Esri',
        maxZoom: maxZoomLevel
    });

    const baseMaps = { "Calles": mapaCalles, "Sat√©lite": mapaSatelital };
    const map = L.map('mapa', { center: [18.218, -66.037], zoom: 13, layers: [mapaCalles] });
    L.control.layers(baseMaps).addTo(map);

    const featureGroup = L.featureGroup().addTo(map);
    const drawControl = new L.Control.Draw({ 
        edit: { featureGroup: featureGroup }, 
        draw: { polyline: false, circle: false, circlemarker: false, marker: false, rectangle: true, polygon: true } 
    });
    map.addControl(drawControl);

    class CoordsAndAddressProvider extends GeoSearch.OpenStreetMapProvider {
        async search(options) {
            const query = options.query;
            const coordPattern = /^(-?\d{1,2}(\.\d+)?),\s*(-?\d{1,3}(\.\d+)?)$/;
            const match = query.match(coordPattern);
            if (match) {
                const lat = parseFloat(match[1]);
                const lon = parseFloat(match[3]);
                return [{ x: lon, y: lat, label: `Coordenadas: ${lat.toFixed(5)}, ${lon.toFixed(5)}`, bounds: null, raw: {} }];
            }
            return super.search(options);
        }
    }

    // --- 3. IMPLEMENTACI√ìN DEL BUSCADOR  ---
    const searchControl = new GeoSearch.GeoSearchControl({
        provider: new CoordsAndAddressProvider(),
        style: 'bar', 
        searchLabel: 'Buscar coordenadas (lat, long)',
        showMarker: false,
        autoClose: true,
    });
    map.addControl(searchControl); 

    map.on('geosearch/showlocation', function (result) {
        const lat = result.location.y;
        const lon = result.location.x;
        crearMarcadorEditable({ lat, lon }, result.location.label);
        map.setView([lat, lon], 18);
    });
    
    let marcadoresCreados = [];
    const messageBox = document.getElementById('message-box');
    let messageTimer;

    function limpiarMarcadores() {
        marcadoresCreados.forEach(marker => map.removeLayer(marker));
        marcadoresCreados = [];
    }

    function mostrarMensaje(texto, tipo, duracion = 5000) {
        clearTimeout(messageTimer);
        messageBox.textContent = texto;
        messageBox.style.backgroundColor = `var(--${tipo}-color)`;
        messageBox.className = 'visible';
        if (duracion > 0) {
            messageTimer = setTimeout(() => { messageBox.className = ''; }, duracion);
        }
    }

    map.on(L.Draw.Event.CREATED, function (event) {
        const layer = event.layer;
        featureGroup.clearLayers().addLayer(layer);
        const bounds = layer.getBounds();
        const bbox = `${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()}`;
        mostrarMensaje("Buscando edificios en el √°rea...", "info");
        buscarEdificios(bbox);
    });

    function buscarEdificios(bbox) {
        limpiarMarcadores();
        const overpassUrl = 'https://overpass-api.de/api/interpreter';
        const query = `[out:json];(way["building"](${bbox}););out center;`;

        fetch(overpassUrl, { method: 'POST', body: "data=" + encodeURIComponent(query) })
        .then(response => response.json())
        .then(data => {
            if (data.elements.length === 0) {
                mostrarMensaje("No se encontraron prospectos en esta √°rea.", "error");
            } else {
                data.elements.forEach(element => {
                    const { lat, lon } = element.center;
                    if (lat && lon) {
                        const nombre = element.tags.name || "Prospecto";
                        crearMarcadorEditable({ lat, lon }, nombre);
                    }
                });
                mostrarMensaje(`¬°Se a√±adieron ${data.elements.length} pines!`, "success");
            }
        })
        .catch(error => console.error('Error al consultar la API Overpass:', error))
        .finally(() => featureGroup.clearLayers());
    }

    function crearMarcadorEditable(latlng, nombre) {
        const marker = L.marker([latlng.lat, latlng.lon], { draggable: true }).addTo(map);
        const popupContent = document.createElement('div');
        popupContent.innerHTML = `<b>${nombre}</b>`;
        const deleteButton = document.createElement('button');
        deleteButton.textContent = 'Eliminar Pin';
        deleteButton.className = 'popup-delete-button';
        deleteButton.onclick = function() {
            map.removeLayer(marker);
            marcadoresCreados = marcadoresCreados.filter(m => m !== marker);
        };
        popupContent.appendChild(deleteButton);
        marker.bindPopup(popupContent);
        marcadoresCreados.push(marker);
    }

    async function exportarKMZ() {
        if (marcadoresCreados.length === 0) {
            mostrarMensaje("No hay puntos para exportar.", "error");
            return;
        }
        let kmlContent = `<?xml version="1.0" encoding="UTF-8"?><kml xmlns="http://www.opengis.net/kml/2.2"><Document><name>Puntos Exportados</name>`;
        marcadoresCreados.forEach(marker => {
            const latlng = marker.getLatLng();
            const nombre = marker.getPopup().getContent().querySelector('b').textContent;
            kmlContent += `<Placemark><name>${nombre}</name><Point><coordinates>${latlng.lng},${latlng.lat},0</coordinates></Point></Placemark>`;
        });
        kmlContent += `</Document></kml>`;
        
        const zip = new JSZip();
        zip.file("doc.kml", kmlContent);
        const content = await zip.generateAsync({ type: "blob" });

        if (window.showSaveFilePicker) {
            try {
                const handle = await window.showSaveFilePicker({
                    suggestedName: 'puntos.kmz',
                    types: [{
                        description: 'Keyhole Markup Language (KMZ)',
                        accept: { 'application/vnd.google-earth.kmz': ['.kmz'] },
                    }],
                });
                const writable = await handle.createWritable();
                await writable.write(content);
                await writable.close();
                mostrarMensaje("Archivo KMZ guardado exitosamente.", "success");
                return;
            } catch (err) {
                if (err.name !== 'AbortError') {
                    console.error('Error al guardar el archivo:', err);
                }
            }
        }
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(content);
        link.download = "puntos.kmz";
        link.click();
        URL.revokeObjectURL(link.href);
    }
    document.getElementById('exportar-kmz-btn').addEventListener('click', exportarKMZ);

    </script>

</body>
</html>